# All-on-443
XRAY-REALITY-VISION-SELF-STEAL + VLESS-CDN-WS + WEBSITE + WEBPANNEL SIMULTANEOUSLY  ALL ON port 443


<img width="738" alt="443" src="https://github.com/user-attachments/assets/294fbd7e-a445-4969-83c8-6821795fb88e">
<br />



**هدف:**<br /> 
ریلیتی و کانفیگ سی دی ان و پنل و سایت html همگی همزمان روی پورت ۴۴۳، به کمک ایپی و دامنه تمیز.<br />شاید بگید رولز کلاودفلر و پورت دستی در رکورد اروان هست چرا سی دی ان روی ۴۴۳ بیاریم، تا زمانی این جواب میداد، بعد سی دی ان های داخلی هم ترافیکشون از دیوار اتش عبور کرد، و کانفیگ های اشتباه سی دی ان ایرانی همگی بلاک شدن.

کانفیگ ریلیتی روی پورت ۴۴۳ و انجینکس روی پورت ۸۴۴۳ خواهد بود.


دامنه ای که sni ریلیتی هست تیک پروکسی سی دی انش باید خاموش باشه، اسکریپت روی سرورمون براش سرتیفیکت میگیره.<br />



فیلد sni در اینباند ریلیتی باید همین دامنه تیک خاموش باشه.


در اینباند ریلیتی dest باید روی 127.0.0.1:8443 باشه، علت: ایکس‌ری میاد هر اتصال غیر ریلیتی رو میفرسته به destو در نتیجه وقتی کسی غیر یوزر ریلیتی درخواستش بهش برسه بدون هیچ تغییری در اون میفرستش دست انجینکس.<br />
این شامل تمام درخواست های اینباندهای سی دی ان، درخواست از طرف مرورگر افراد برای باز کردن دامنه ما، و درخواست شما برای باز کردن پنل که شامل دامنه و مسیر پنل هست میشه. بدون هیچ تغییری میرسن دست انجینکس. پس این یعنی اگر مهارت کار با انجینکس داشته باشید، میتونید پروکسی تلگرام روی ۴۴۳ با فیک تی ال اس و حتی اس اس اچ روی ۴۴۳ بیارید بالا ولی من فعلا چنین کاری رو یاد ندارم و ابزار SSLH رو پیدا کردم برای اینکار.


چرا مدیریت کننده پورت ۴۴۳ ایکس‌ری باشه نه انجینکس؟ در گروه روسی زبان هسته به این نتیجه رسیده شد که اون برنامه مواجه شونده با رکوئست های غیر مجاز(چه افراد چه سیستم فیلترینگ) خود هسته باشد بهتر از انجینکس هست. وگرنه شما میتونید با بلوک استریم و pre read درخواست های ریلیتی رو بفرستید برای هسته و این انجینکس باشه که در ۴۴۳ درخواست ها رو مدیریت کند.


دوستان پرسیده بودن چرا ریلیتی رو نمیشه پشت سی دی ان انداخت، علتش استفاده از tcp هست، سی دی ان میخواد محتوا رو کش کنه لاکن ما میخواهیم در لحظه همه چیز به سرور برسه. برای همین در اینباندهای سی دی ان از ws و grpc یا split استفاده میشه. در نظر داشته باشید اخرین بار که گیتهاب هسته رو دیدم نوشته بود ویژن برای اسپلیت هم امده، اگر تونستید ان رو امتحان کنید، مشکل ما با سی دی ان خارجی اون تشخیض tls-in-tls بود، من خودم روی یک دامنه ۷۵۰ گیگ با کلاودفلر عبور دادم بعدش طوری شد سایت بالا می‌امد ولی وی پی ان وصل نمیشد، فقط اتصال مرورگر واقعی جواب میداد.(راه حلش browser dialer هست، 2dust گفت علاقه ای به اجراش نداره سخته براش) البته که بعدا روش همین ریلیتی رو اجرا کردم و بدون مشکلی کار کرد.


اسکریپت زیر از GFW4FUN برای ما پنل و انجینکس رو نصب میکنه و گواهی امنیتی دامنه رومیگیره. <br />
https://github.com/GFW4Fun/x-ui-pro



در عکس زیر هوهنهایم روی سی دی ان و دوتای دیگه مستقیم همگی روی یک سرور همزمان هستند.(خاموش کردن اروان بعد از ۵۰ گیگ علت دیگری داشت اما برای تست خوب بود. که بدانید همزمان از سی دی ان اروان ابردراک زس اراز و کلاودفلر جی کور فستلی و همه و همه روی یک پورت ۴۴۳ همگی tls میتونید استفاده کنید، شرط لازم و کافی پشتیبانی از وبسوکت یا splithttp هست. )<br />


![Screenshot 2024-11-03 083003](https://github.com/user-attachments/assets/820e9639-91df-4626-b780-7cddc20d658e)


از هر سی دی انی که وبسوکت پشتیبانی کنه یا اگر نداشت از splithttp پشتیبانی کنه میتونید استفاده کنید، همزمان هم میتونید استفاده کنید .<br />
برای هر سی دی ان قاعدتا باید دامنه مجزا واردش کنید.


مشکل این روش محدود شدن شما به یک اینباند ریلیتی هست، اما با وجود داشتن شورت ایدی و uuid مشکلی نیست.<br /> اگر اتصال با اختلال کم میخواهید از سی دی ان ایرانی استفاده کنید ولی تا جای ممکن مستقیم وصل بشید.


![443](https://github.com/user-attachments/assets/812788ee-0cb7-4454-b768-4f463586eec9)



# Setup

اول دیوار اتش سرور رو غیرفعال میکنیم.
```
ufw disable
```



از اسکریپت این دوست چینی برای نصب و تنطیم پنل انجینکس و دامنه استفاده میکنیم.
```
sudo su -c "$(command -v apt||echo dnf) -y install wget;bash <(wget -qO- raw.githubusercontent.com/GFW4Fun/x-ui-pro/master/x-ui-pro.sh) -panel 1 -cdn off"
```
در جریان باشید اسکریپتش خیلی چیزهای اضافی مثل تور سایفون وارپ وی۲ری پنل نصب میکنه، کرون تب ریستارت انجینکس هسته ایکس ری روزانه و تمدید گواهی های امنیتی به صورت ماهانه هم تنظیم میکنه.<br />


**اون لینکی که برای پنل میده رو، کپی کنید**، s رو از https پاک کنید، جلوی دامنتون پورتی که گفت مربوط به پنل هست رو بذارید و تا موقع راه اندازی کامل با این لینک پنل رو مدیریت کنید. بعد از پایان کار با همون لینک https بدون پورت میتونید، قبل از بستن این ادرس پورت دار تو یک تب دیگه چک کنید که پنل https بالا میاد یا خیر.


اسکریپتش برای نصب دامنه های بعدی میتونه بارها و بارها اجرا بشه، اما داره هربار کد رو تغییر میده و یهو دیدید زد یک چیزی رو خراب کرد سرور کلا خوابید، من خودم هرچی اضافه داره رو حذف کردم، از یک نسخه به بعد تنظیمات انجینکسش دیگه دست نخوردن، و بنظرم دیگه نیازی هم نداریم بیشتر از اون.<br />


**مهم:** **حتما حتما سایت فیک رو بالا بیارید**، در اموزش ویدئویی و اموزش متنی قبلی خود من تاکیدی نشد اما اینبار تاکید میکنم این دستور رو اجرا کنید و یک سایت اچ تی ام ال خودش بالا میاره.
```
bash <(wget -qO- raw.githubusercontent.com/GFW4Fun/x-ui-pro/master/x-ui-pro.sh) -RandomTemplate yes
```


حالا کانفیگ انجینکس برای دامنه رو تغییر میدیم: 
```
sudo nano /etc/nginx/sites-available/yourdomain.com
```
<br />


۴۴۳ ها رو تغییر بدید به ۸۴۴۳<br />
شما میتونید از سوکت دامنه یونیکس unix domain socket برای اتصال انجینکس و ایکس‌ری استفاده کنید، راحت هست اما اینجا نیاوردمش.تعداد اتصالات تی سی پی لوکال بین انجینکس و ایکس‌ری رو بسیار کاهش میده، من ۳۰۰۰ تا کانکشن در پنل میدیدم با اجرای این روش اومد ۵۰ تا، علت پیشنهادم این هست که سازنده ایکس‌ری و ویکی لینوکس گفتن از پورت لوکال عملکرد بهتری داره و در استفاده های تعداد بالا خودش رو خیلی خوب نشون میده.


![Screenshot 2024-11-03 091246](https://github.com/user-attachments/assets/292dc711-22a8-470f-8012-6aa05c1c55a9)


To this:


![Screenshot 2024-11-03 091207](https://github.com/user-attachments/assets/e395e357-5959-4c1d-b7ce-1c21de24cbc4)


تست کانفیگ جدید انجینکس و راه اندازه دوباره
```
ln -fs "/etc/nginx/sites-available/yourdomain.com" "/etc/nginx/sites-enabled/"
sudo nginx -t
sudo systemctl reload nginx
sudo systemctl restart nginx
```


اگر به ارور برخورد کردید:
```
sudo fuser -k 80/tcp
sudo fuser -k 443/tcp
sudo fuser -k 8443/tcp
sudo systemctl start nginx
```
و دستورات بلوک قبلیش رو دوباره اجرا کنید.

# Xray 

ساخت اینباند ریلیتی<br />


![image](https://github.com/user-attachments/assets/e7d96b83-027c-415f-b5d0-1255f8d4a0c9)
![image](https://github.com/user-attachments/assets/b040064f-c7ec-47cb-8f0b-6397eba2f464)

پورت ۴۴۳، پروتوکل ویلس، بعد میرید پایین security رو میگذارید روی ریلیتی، بعد روی clients کلیک میکنید باز بشه، بعد براش flow رو روی **xtls-rprx-vision** تنظیم میکنید، اما حتما پس از این که کاربر جدید هم ساختید برای اون ها هم موقع ساخت این رو تنظیم کنید در همون پنجره کوچکی که باز میشه برای ساخت گزینش **(flow)** خواهد بود، xtls-rprx-vision-udp443 رو انتخاب **نکنید**!<br />
شورت ایدی ها رو **پاک نکنید!**
اسپایدر ایکس رو خالی **نگذارید**، میتونید چندین اسپایدرایکس قرار بدین داخل این فیلد، سازنده گفته به ازای هر کلاینت متفاوت بدین ولی خب امکانش رو من ندیدم چطور تنظیم کنیم که هربار کپی کردن یک رندوم رو بردارد، باید به مهندس ثنایی بگیم همونطوری که تنظیم کرده با هرکلاینت شورت ایدی متفاوتی بده باید برای اسپایدرایکس هم بگیم اگر میتونه این رو قرار بده.از اون سمت هم میگن در بهتر کردن اتصال تاثیری نداره، پس اصلا چرا هست رو خود rprx میدونه.



**نحوه ساخت اینباند سی دی ان از صفحه دوست چینی:**<br />
توجه کنید که اینجا دامنه ای که تیک پروکسی سی دی انش روشن هست استفاده کنید. مطابق ویدئوی اموزشی.
**مهم** حتما utls رو روی chrome بگذارید، رندوم که از همین ها یکی انتخاب میکنه اما رندومایزد هربار یک مشخصه میسازه و در صحبت با دوستان چینی اینطوری گفتن همون بهتر chrome باشه برای همه.


من در اموزش متنی خودم منظورم این بود برای سی دی ان هم باید اول تیک پروکسی سی دی ان رو خاموش کنید بعد براش اسکریپت gfw4fun رو اجرا کنید، تنظیم که شد برید پورت های داخل کانفیگ اون دامنه رو مثل دامنه ریلیتی تغییر بدید.بعد هم برگردید تیک سی دی ان رو روشن کنید، تا برای اونها هم سایت بالا بیاد. نحوه پاسخ انجینکس به درخواست ورودی که براش سایتی تنظیم نشده را نمیدونم چه هست، احتمال زیاد سایت بالا نخواهد امد یا حداقل https نخواهد بود، چون گواهی های امنیتی اون دامنه رو نداره.

From https://github.com/GFW4Fun/x-ui-pro#server-configuration-wrench <br />



![image](https://github.com/user-attachments/assets/4db3a6c3-62a1-4abe-bda6-171cf0ad2bc7)
![image](https://github.com/user-attachments/assets/e9ab2e33-71b1-45f0-9b77-0469cd69d81f)
![image](https://github.com/user-attachments/assets/7f914763-564d-464f-a10d-c7bdde12e5cb)




For ufw

فعالسازی دوباره دیواراتش سرور، پورت ۲۷۸۹ مربوط به اس اس اچ من هست با مال خودتون عوض کنید، همچنین اگر امکانش بود پورت پنل رو باز نگذارید و موقع ضرورت قوانین دیواراتشتون رو بروز کنید که پورت پنل رو اجازه بده تغییرات یا درست کردنش رو انجام بدید بعد برگردونید به حالت قبلی. تمام هدف این هست پورت های کمی از سرور باز باشن، و پاسخ سرور به درخواست های نامعتبر مثلا درخواست های سیستم فیلترینگ واکنش یک سایت واقعی رو بده.<br />
```
ufw status
ufw reset
ufw default deny incoming
ufw default allow outgoing
ufw allow 80,443,2789/tcp
ufw allow 80,443,2789/udp
```

فعال سازی در اخر
```
ufw enable
```

# چرا بازگشت به ریلیتی؟
سازنده هسته یعنی rprx و یکی از دوستانش fangliding در گفت‌وگوی گیتهاب گفتند بنظرشون این تشخیص ریلیتی نیست و مشکل از اشتباه کانفیگ کردن ما هست.<br />
https://github.com/XTLS/Xray-core/discussions/3269<br />در همون بحث خود rprx گفته من چندین روش جدید قدرتمندتر هم ساختم و تو استین دارم برای وقتی که ریلیتی رو در چین بزنن، تا اون زمان ارائشون نمیکنم، fangliding هم توضیح داد که در dest و sni وقتی سایتی مثل گوگل یا زولا میزنید، یا هرسایت معروف یا غیر معروف که ایپیش روی سابنت شما نیست،  دیوار اتش با دادن رکوئست که توسط ایکس‌ری میرسه به ‌dest و پینگ کردن ‌sni متوجه میشه شما ایپیت با ایپی اون sni همخوانی نداره و دقیقا مشابه یک port forwarder تشخیصت میده. <br />همچنان دوستان ایرانی این حوزه معتقد هستن خیر فیلترینگ ما به قدرت تشخیص ریلیتی رسیده. به هرحال، دوستان چینی برای حل این مسئله  sni shunting استفاده کردن ترجمش میشه از مسیر اصلی خارج کردن sni، وقتی رکوئست دیوار اتش رسید به هسته و اون دادش به انجینکس، انجینکس مثلا گوگل یا زولا رو نمایش بده اما ایپی که به دست ارسال کننده درخواست میرسه ایپی سرور ما باشه. بنابراین شما میتونید شانتینگ رو هم تست کنید، چون به هرحال در SNI گوگل یا هر سایت لیست سفید دیگری خواهد بود و خب این بهتر هست، مگر اینکه با یک تغییر ساده SNI سایت های مشکوک رو خود دیواراتش ایران به ایپی تبدیل کنه و با ایپی مقصد مقایسه کنه. وقتی دارید هتزنر استفاده میکنید و SNI گوگل هست این واضح است که هتزنر با گوگل نه ایپی و نه ASN مربوط به هم دارند، پس شاید، شاید برای سایت های غیرمعروف جواب بده، که اون موقع به این نتیجه میرسیم چرا یک دامنه نخریم و محکم کاری نکنیم.<br />
https://github.com/chika0801/Xray-examples/tree/main/VLESS-Vision-REALITY/nginx_sni_shunting


بعد خواندن این بحث من با توجه به مشخصات سیستم حاکم بر کشور مطمئن شدم چیزی که ما داشته باشیم و چین و روسیه نداشته باشند وجود ندارد، خصوصا در حوزه it، برای صحت سنجی یک کانفیگ ریلیتی در مهسا انجی پخش کردم.بعد از یک ترابایت از همه اپراتورها از سراسر کشور در نهایت ایپی خورد.(دامنه کاملا سالم هست و من روش دوباره ریلیتی بالا اوردم تا الان ۵۰۰ گیگ عبور داده، بعضی دوستان همین اخیرا در گروه ها میگفتن با ریلیتی ما تو ۳ ماه تا ۵ ترابایت هم عبور دادیم قبل زده شدن ایپی.


ستاپ اشتباه بود، ریلیتی پورت ۸۴۴۳ و سایت ۴۴۳. همچنین احتمال دخالت گزارشگران ایپی به کمک یک نرم افزاری مثل وایرشارک ولی برای اندروید هم بود. یا حتی اجرای مهساانجی روی بلواستک و استفاده از همان وایرشارک. چرا این حرف رو میزنم؟ علتش این هست که روی همون سرور بالا(سروری که بعدش حالت سایت و ریلیتی روی یک پورت رو اجرا کردم نه سرور کانفیگ مهساانجی که بعد یک ترا فیلتر شد) من ستاپ اشتباه رو پیاده کردم، ۱۵۰ گیگابایت ازش رد شد، همه روی همراه اول، بدون بسته شدن ایپی.


![image](https://github.com/user-attachments/assets/e20a2057-cb5a-4696-ac89-7ccc7260c40f)

![image](https://github.com/user-attachments/assets/39066134-7f1c-4bc0-bba0-489d389136ad)

![image](https://github.com/user-attachments/assets/e1f68c98-a7a4-435f-89a3-524f1d161786)


همراه اولی ها ۵۶۰ گیگابایت مصرف کردند، ایرانسلی ها ۲۶۰ گیگابایت.



**یک نکته** از سازنده پنل کافکا رو دیدم که بد نیست اینجا هم بگم: هدف ساخت وی‌پی‌ان مبتنی بر tls این هست که ترافیک ما کاربران و سرورمون به طور کامل شبیه به بازدید از یک سایت https(اتصال همه کاربران فقط به ۴۴۳) عادی باشه.



به کمک REALITY به عنوان security اینباند، مشخصه های یک اتصال tls به طور بی نقص شبیه سازی میشه (tls1.3 x25519)


مشخصه های یک مرورگر واقعی رو utls میسازه(chrome) (توجه: کتابخانه utls باز هست و فیلترچی میتونه براحتی بررسیش کنه و بالاخره مشخصه هایی ازش که نیاز داره رو بدست بیاره تا تشخیصش بده)(Fingerprint)


و xtls-rprx-vision مشکل تشخیص tls-in-tls رو حل میکند.(Deep Packet Inspection DPI)


فالبک هم که در اینباند ریلیتی dest شده به درخواست های نامعتبر یک سایت واقعی را نشون میده.(ACTIVE PROBING)
